-- 1. Create the contact_requests table
create table public.contact_requests (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  name text not null,
  phone text not null,
  email text not null,
  description text not null,
  file_url text
);

-- 2. Enable Row Level Security (RLS)
alter table public.contact_requests enable row level security;

-- 3. Create a policy to allow anyone to INSERT (since it's a public contact form)
create policy "Enable insert for everyone"
on public.contact_requests
for insert
to public
with check (true);

-- 4. Create a policy so ONLY service_role (backend/admin) can SELECT/VIEW data
-- This prevents public users from reading other people's submissions via the API
create policy "Enable read access for service_role only"
on public.contact_requests
for select
to service_role
using (true);

-- 5. Create Storage Bucket for file uploads
insert into storage.buckets (id, name, public)
values ('contact-uploads', 'contact-uploads', true)
on conflict (id) do nothing;

-- 6. Storage Policies (Allow public to upload, but maybe restrict viewing)

-- Allow public uploads to 'contact-uploads' bucket
create policy "Allow public uploads"
on storage.objects
for insert
to public
with check ( bucket_id = 'contact-uploads' );

-- Allow public to view files (since we return the public URL)
create policy "Allow public viewing"
on storage.objects
for select
to public
using ( bucket_id = 'contact-uploads' );